<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 9.1.1 (458383)"/><meta name="author" content="taking"/><meta name="created" content="2019-06-06 04:25:44 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2019-08-28 06:13:22 +0000"/><title>【操作文档】ceph不停机从J版(10.x)升级到L版(12.x)的操作文档v2.2</title></head><body><div><div><span style="font-size: 18px;">rpm下载地址：</span></div><blockquote style="box-sizing: border-box; outline: 0px; padding: 16px; border-left-width: 8px; border-left-style: solid; border-left-color: rgb(221, 223, 228); background-color: rgb(238, 240, 244); overflow: auto; word-wrap: break-word; caret-color: rgba(0, 0, 0, 0.498039); font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; word-break: break-word !important;"><div><a href="http://pan.bingosoft.net:81/drive/share/open_sharepage/a7f7b02c-9955-4996-850f-f399dcbbcb69:bingo" style="caret-color: rgb(0, 0, 0); font-size: 12px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(248, 247, 241); color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, Tahoma, SimSun, Verdana; font-variant-caps: normal;">http://pan.bingosoft.net:81/drive/share/open_sharepage/a7f7b02c-9955-4996-850f-f399dcbbcb69:bingo</a></div><div><span style="font-size: 14px; font-family: Courier;">【密码：</span><span style="caret-color: rgb(0, 0, 0); font-size: 12px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(248, 247, 241); color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, Tahoma, SimSun, Verdana; font-variant-caps: normal;">TYPz</span><span style="font-size: 14px; font-family: Courier;">】</span></div></blockquote><hr/><div>1、<span style="font-family: Courier;">备份所有节点的旧版本jewel安装文件所在目录，并删除/opt/ceph下的install目录</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># mv /opt/bingocloud/latest/output/tools/install/res/rpm-el7/ceph /opt/bingocloud/latest/output/tools/install/res/rpm-el7/ceph.jewel</div><div># rm -rf /opt/ceph/install /opt/ceph/install.sh</div></div><div><br/></div><div><span style="font-family: Courier;">2、上传</span><span style="font-family: Courier;">ceph-luminous-12.2.12.tar.gz到所有服务器/tmp目录下，并将</span><span style="font-family: Courier;">ceph-luminous-12.2.12.tar.gz解压到</span><span style="font-family: Courier;">/opt/bingocloud/下。</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># tar zxvf /tmp/ceph-luminous-12.2.12.tar.gz -C /opt/bingocloud/latest/output/tools/install/res/rpm-el7</div></div><div>⚠️如该环境为3个副本执行以下指令修改全部节点安装目录下的默认配置文件：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>sed -i "s/osd_pool_default_size.*/osd_pool_default_size\ =\ 3" /opt/bingo cloud/latest/output/tools/install/res/rpm-el7/ceph/install/conf/ceph.conf</div></div><div>⚠️如该环境为故障域优化的需执行以下指令修改全部节点安装目录下的默认配置文件：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>sed -i "s/osd_crush_update_on_start.*/osd_crush_update_on_start\ =\ false/" /opt/bingocloud/latest/output/tools/install/res/rpm-el7/ceph/install/conf/ceph.conf</div></div><div><br/></div><div>3、在/var/www/html下新建ceph-luminous-12.2.12目录，并为该目录新建一个软链接。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># mkdir /var/www/html/ceph-luminous-12.2.12</div><div># ln -s /opt/bingocloud/latest/output/tools/install/res/rpm-el7/ceph/install/rhel7 /var/www/html/ceph-luminous-12.2.12</div></div><div><br/></div><div>4、在yum源服务器的/etc/yum.repos.d/编辑yum配置文件ceph-luminous-12.2.12.repo。（根据实际环境修改IP地址和端口）将配置文件传递到所有主机/etc/yum.repos.d/</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># vim /etc/yum.repos.d/ceph-luminous-12.2.12.repo</div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[ceph-luminous]</div><div>name=ceph-luminous-12.2.12</div><div>baseurl=http://<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">10.202.156.1:8011</span>/ceph-luminous-12.2.12/rhel7</div><div>enabled=1</div><div>gpgcheck=0</div></div><div><br/></div><div>5、在任一节点上设置sortbitwise和noout标志位（sortbitwise必须设置否则有丢数据风险，默认开启）</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># ceph osd set sortbitwise</div><div># ceph osd set noout</div></div><div><br/></div><div>6、全部节点上运行以下指令更新ceph</div><div>⚠️<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">如环境由hammer（0.94.x）升级到jewel（10.2.x），要继续升级到luminous（12.2.x）之前需要执行rpm -e ceph删除节点上的ceph包。</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># yum update -y ceph-common ceph-mon ceph-osd ceph-mds ceph-fuse ceph-radosgw ceph-dash</div></div><div><br/></div><div>7、全部节点上备份ceph jewel配置文件并复制新的luminous配置文件传到所有节点/etc/ceph下。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># mv /etc/ceph/ceph.conf /etc/ceph/ceph.conf.jewel</div><div># cp&nbsp;&nbsp;/opt/bingocloud/latest/output/tools/install/res/rpm-el7/ceph/install/conf/ceph.conf /etc/ceph/</div></div><div><br/></div><div>8、全部节点上修改配置文件</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>sed -i "s/fsid.*/`sed -ne "/fsid/p" /etc/ceph/ceph.conf.jewel`/" /etc/ceph/ceph.conf</div><div>sed -i "s/mon_host.*/`sed -ne "/mon_host/p" /etc/ceph/ceph.conf.jewel`/" /etc/ceph/ceph.conf</div><div>sed -i "s/public_addr.*/`sed -ne "/public_addr/p" /etc/ceph/ceph.conf.jewel`/" /etc/ceph/ceph.conf</div><div>sed -i "s/cluster_addr.*/`sed -ne "/cluster_addr/p" /etc/ceph/ceph.conf.jewel`/" /etc/ceph/ceph.conf</div><div>sed -i "s/osd_crush_update_on_start.*/osd_crush_update_on_start = false/" /etc/ceph/ceph.conf</div></div><div><br/></div><div>9、按顺序重启所有ceph服务</div><ul><li><div>在每一个mon节点重启mon服务</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># systemctl restart ceph-mon.target</div></div><ul><li><div>重启每一个osd服务<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">(待集群状态恢复正常即health ok 才能对下一个节点重启)</span></div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># systemctl stop ceph-osd.target&nbsp;&nbsp;&nbsp;&nbsp; //停止节点上所有osd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </div><div># ps -ef |grep osd &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //确定osd已全部停止 </div><div>#&nbsp;&nbsp;for i in `df -h |grep ceph |grep -v bcshare |awk '{print $6}'` ;do umount $i;done&nbsp;&nbsp;&nbsp;&nbsp; //umount所有osd的挂载目录 </div><div>#&nbsp;&nbsp;/opt/ceph/bin/ceph-osd.sh & &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//通过脚本启动节点上所有osd </div></div><ul><li><div>重启每一个mds服务</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># systemctl restart ceph-mds.target</div></div><ul><li><div>重新挂载每个bcshare目录</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># umount /bcshare</div><div># /opt/ceph/bin/cephfsmount.sh &amp;</div></div><div><br/></div><ul><li><div>重启每一个radosgw服务</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># systemctl restart ceph-radosgw.target</div></div><ul><li><div>重启每一个ceph-dash服务</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># /etc/init.d/ceph-dash restart</div></div><div><br/></div><div>10、在每一个mon节点安装mgr并启动服务，服务序号与mon一致。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>yum -y install ceph-mgr</div><div>systemctl start ceph-mgr@0</div><div>systemctl enable ceph-mgr@0</div></div><div><br/></div><div>11、任一节点执行以下指令确保所有mon、osd、mds、rgw都为12.2.12</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#ceph versions</div></div><div>正常结果与下图类似：</div><div><img src="%E3%80%90%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A3%E3%80%91ceph%E4%B8%8D%E5%81%9C%E6%9C%BA%E4%BB%8EJ%E7%89%88(10.x)%E5%8D%87%E7%BA%A7%E5%88%B0L%E7%89%88(12.x)%E7%9A%84%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A3v2.2.resources/165A8E88-4405-4EF7-9B7D-B0975DBECB7D.png" height="570" width="1830"/></div><div><br/></div><div>12、在任一mon执行如下指令要求osd至少为luminous版本和允许水位平衡</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># ceph osd require-osd-release luminous</div><div># ceph osd unset noout</div></div><div><br/></div><div>13、&nbsp;&nbsp;<span style="font-family: Courier;">出现</span><span style="font-family: Courier;">application not enabled on 1 pool(s)警告时需要设置池的类型</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># ceph -s</div><div>&nbsp;&nbsp;&nbsp;&nbsp;cluster:</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;35006308-1f10-44ca-81f2-02dcd19ac068</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;health: HEALTH_WARN</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;application not enabled on 1 pool(s)</div></div><div>执行以下指令设置instances池的类型为rbd：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># ceph osd pool application enable instances rbd</div></div><div>当前常见池使用类型有三种</div><blockquote style="box-sizing: border-box; outline: 0px; padding: 16px; border-left-width: 8px; border-left-style: solid; border-left-color: rgb(221, 223, 228); background-color: rgb(238, 240, 244); overflow: auto; word-wrap: break-word; caret-color: rgba(0, 0, 0, 0.498039); font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; word-break: break-word !important;"><div><span style="font-size: 14px; color: rgba(0, 0, 0, 0.498); font-family: Courier; font-variant-caps: normal;">CephFS uses the application name cephfs</span></div><div><span style="font-size: 14px; color: rgba(0, 0, 0, 0.498); font-family: Courier; font-variant-caps: normal;">RBD uses the application name rbd</span></div><div><span style="font-size: 14px; color: rgba(0, 0, 0, 0.498); font-family: Courier; font-variant-caps: normal;">RGW uses the application name rgw</span></div></blockquote><div><br/></div><div>14、在第一台mon上执行以下指令设置计划任务定时调整pg</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#&nbsp;&nbsp;cp /opt/bingocloud/latest/output/tools/install/res/rpm-el7/ceph/install/bin/ceph-balancer.sh&nbsp;&nbsp;/opt/ceph/bin</div><div># chmod +x /opt/ceph/bin/ceph-balancer.sh</div><div># echo "* * * * * /opt/ceph/bin/ceph-balancer.sh" &gt;&gt; /var/spool/cron/root</div></div><div><br/></div><div>15、升级完成与下图类似：</div><div><img src="%E3%80%90%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A3%E3%80%91ceph%E4%B8%8D%E5%81%9C%E6%9C%BA%E4%BB%8EJ%E7%89%88(10.x)%E5%8D%87%E7%BA%A7%E5%88%B0L%E7%89%88(12.x)%E7%9A%84%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A3v2.2.resources/7062AF27-8950-4B27-BA2F-529250B27274.png" height="628" width="1236"/></div><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div></body></html>