<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 9.1.1 (458383)"/><meta name="author" content="taking"/><meta name="created" content="2019-07-24 11:21:50 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2019-09-10 07:31:06 +0000"/><title>【操作文档】ceph不停机从H版(0.94.x)升级到J版(10.x)的操作文档v1.2</title></head><body><div><span style="font-size: 18px;"> rpm下载地址：</span></div><blockquote style="box-sizing: border-box; outline: 0px; padding: 16px; border-left-width: 8px; border-left-style: solid; border-left-color: rgb(221, 223, 228); background-color: rgb(238, 240, 244); overflow: auto; word-wrap: break-word; caret-color: rgba(0, 0, 0, 0.498039); font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; word-break: break-word !important;"><div><a href="http://pan.bingosoft.net:81/drive/share/open_sharepage/bf1ebfdb-faed-4cb9-b473-b18701f35f0e:bingo" style="caret-color: rgb(0, 0, 0); font-size: 12px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(248, 247, 241); color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, Tahoma, SimSun, Verdana; font-variant-caps: normal;">http://pan.bingosoft.net:81/drive/share/open_sharepage/bf1ebfdb-faed-4cb9-b473-b18701f35f0e:bingo</a></div><div><span style="font-size: 14px; font-family: Courier;">【密码：</span><span style="caret-color: rgb(0, 0, 0); font-size: 12px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(248, 247, 241); color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, Tahoma, SimSun, Verdana; font-variant-caps: normal;">35Z2</span><span style="font-size: 14px; font-family: Courier;">】</span></div></blockquote><div><br/></div><div>⚠️注意事项：</div><blockquote style="box-sizing: border-box; outline: 0px; padding: 16px; border-left-width: 8px; border-left-style: solid; border-left-color: rgb(221, 223, 228); background-color: rgb(238, 240, 244); overflow: auto; word-wrap: break-word; caret-color: rgba(0, 0, 0, 0.498039); font-size: 14px; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; word-break: break-word !important;"><div><span style="font-size: 14px;">1、低于0.94.4的hammer版本不可直接升级到jewel，必须先升级到0.94.4或以上。</span></div><div><span style="font-size: 14px;">2、所有0.94.x版本均为手动部署，每个环境都有差异，某些步骤可能与文档不同。</span></div><div><span style="font-size: 14px;">3、升级对实例无影响但radosgw会中断，升级前需确保radosgw服务可以停机。</span></div></blockquote><hr/><div>1、<span style="font-family: Courier;">备份所有节点的旧版本hammer安装文件所在目录</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># mv /opt/bingocloud/latest/output/tools/install/res/rpm-el7/ceph /root/ceph-0.94</div></div><div><br/></div><div>2、<span style="font-family: Courier;">上传</span><span style="font-family: Courier;">ceph-10.2.11.tar.gz到所有服务器/tmp目录下，并将</span><span style="font-family: Courier;">ceph-10.2.11.tar.gz解压到</span><span style="font-family: Courier;">/root/下。</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># tar zxvf /tmp/ceph-10.2.11.tar.gz -C /root/</div></div><div><br/></div><div>3、设置noout标志位，禁止水位平衡</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># ceph osd set noout</div></div><div><br/></div><div>4、每个节点更新jewel程序</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>RHEL7.3运行：</div><div># yum install -y /root/ceph-10.2.11/*.rpm &amp;&amp; date +%s &gt;&gt; /tmp/ceph_update_jewel_time</div><div><br/></div><div>RHEL7.1运行：</div><div># yum install -y /root/ceph-10.2.11/*.rpm /root/ceph-10.2.11/systemd/*.rpm &amp;&amp; date +%s &gt;&gt; /tmp/ceph_update_jewel_time</div></div><div><br/></div><div>5、每个节点运行以下脚本更新ceph配置文件</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># sh /root/ceph-10.2.11/conf/0.change_conf.sh -h</div><div>Usage: sh 0.change_conf.sh [-p public_ip] [-c cluster_ip] [-a public and cluster ip]</div></div><div><br/></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">例1：public ip和cluster ip不同</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># sh /root/ceph-10.2.11/conf/0.change_conf.sh -p 10.202.186.1 -c 192.168.186.1</div></div><div><br/></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">例2：public ip和cluster ip一样</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># sh /root/ceph-10.2.11/conf/0.change_conf.sh -a 10.202.186.1</div></div><div><br/></div><div>6、按顺序重启所有ceph服务</div><ul><li><div>在每一个mon节点重启mon服务</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># sh /root/ceph-10.2.11/conf/1.restart-mon.sh</div></div><ul><li><div>重启每一个osd服务<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">(待集群状态恢复正常即health ok 才能对下一个节点重启)</span></div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># sh /root/ceph-10.2.11/conf/2.restart-osd.sh</div></div><ul><li><div>重启每一个mds服务</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># sh /root/ceph-10.2.11/conf/3.restart-mds.sh</div></div><ul><li><div>所有mds客户端运行以下脚本重新挂载/bcshare目录<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">（如脚本运行失败可能该主机上有实例挂载iso）</span></div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># sh /root/ceph-10.2.11/conf/4.remount-mds.sh</div></div><ul><li><div>重启radosgw服务</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># sh /root/ceph-10.2.11/conf/5.restart-rgw.sh</div></div><div><br/></div><div>7、升级后设置相关标志位</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># ceph osd set require_jewel_osds</div><div># ceph osd set sortbitwise</div><div># ceph osd unset noout</div></div><div><br/></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">8、确保所有</span><span style="background-color: rgb(255, 250, 165); font-family: Courier;-evernote-highlight:true;">客户端已安装相同版本的ceph后，在云平台上通过热迁移实例触发实例使用新版本ceph client程序。</span></div><div><span style="font-size: 12px; --inversion-type-color:  simple;"><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># rpm -qa |grep ceph-common                                  //检查所有客户端是否为Jewel版本</div></div></span></div><div><br/></div><div><br/></div><div><span style="background-color: rgb(255, 250, 165); font-family: Courier;-evernote-highlight:true;">9、全部计算节点运行7</span><span style="background-color: rgb(255, 250, 165); font-family: Courier;-evernote-highlight:true;">.chk-client-versions.sh检查是否有遗漏，如输出为</span><span style="background-color: rgb(255, 250, 165); font-family: Courier;-evernote-highlight:true;">The startup time of i-B2CFAA5D is earlier than update time!</span><span style="background-color: rgb(255, 250, 165); font-family: Courier;-evernote-highlight:true;"> </span><span style="background-color: rgb(255, 250, 165); font-family: Courier;-evernote-highlight:true;">表示该ceph实例未在升级后迁移，客户端可能为Hammer版。</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># sh /root/ceph-10.2.11/conf/7.chk-client-versions.sh         //检查所有计算节点上是否有未迁移的ceph实例</div><div>The startup time of i-B2CFAA5D is earlier than update time!</div><div>The startup time of i-A30A4ED8 is earlier than update time!</div></div><div><br/></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">10、必须将<span style="font-size: 14px; background-color: rgb(255, 250, 165);-evernote-highlight:true;">全部实例执行热迁移后</span><span style="background-color: rgb(255, 250, 165); font-family: Courier;-evernote-highlight:true;">运行tunables，否则旧版本client不兼容12版本的crush</span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># ceph osd crush tunables optimal                            //会引起最多10%的数据平衡</div></div><div><br/></div><div><br/></div><div><span style="font-size: 12px; white-space: pre; --inversion-type-color:  simple;"><br/></span></div><div><span style="font-size: 12px; white-space: pre; --inversion-type-color:  simple;"><br/></span></div><div><span style="font-size: 12px; white-space: pre; --inversion-type-color:  simple;"><br/></span></div><div><span style="font-size: 12px; white-space: pre; --inversion-type-color:  simple;"><br/></span></div><div><span style="caret-color: rgb(51, 51, 51); font-size: 12px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: pre; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><br/></span></div><div><span style="caret-color: rgb(51, 51, 51); font-size: 12px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: pre; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><br/></span></div><div><span style="caret-color: rgb(51, 51, 51); font-size: 12px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: pre; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><br/></span></div></body></html>